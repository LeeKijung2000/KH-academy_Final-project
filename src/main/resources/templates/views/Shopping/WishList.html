<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>찜&gt;&lt;</title>
<link rel="stylesheet" href="../../../css/user/userCommon.css"/>

 <!-- 아이콘(CDN) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer" />
<style>
body {
	background: #f7f8f9;
}

.all{
margin-right: 3%;
	margin-left: 7%;
	margin-bottom:3%;
	margin-top:2%;
}
.wish-Top {
	display: flex;
	justify-content: space-between;
	align-items: center;
}
#checkdelete {
	float: right;
	font-size: 16px;
	background: none;
	border: none;
	color: gray;
}

#checkdelete:hover {
	font-weight: bold;
	color: black;
}
#sort {
	border: 1px solid #ccc;
	border-radius: 8px;
	padding: 8px 8px;
	font-size: 16px;
	outline: none;
	cursor: pointer;
}

.quantity {
	color: gray;
	margin-left: 2%;
	margin-right: 2%;
	font-size: 18px;
}

hr {
	margin-bottom: 1.5%;
}

.product-list {
	display: flex;
	gap: 5%;
	margin-left: 2%;
	align-items: center;
	flex-wrap: wrap;
}

.product-item {
	display: flex;
	align-items: flex-start;
	width: 20%;
	margin-top: 1.5%;
	flex-direction: column;
}

.check {
	margin-bottom: 6%;
	transform: scale(1.5);
	cursor: pointer;
}

.product-image {
	position: relative;
	display: flex;
	align-items: center;
	justify-content: center;
	margin-bottom: 8px;
	width: 240px; /* 고정 크기 */
	height: 230px;
	border-radius: 6px;
}

.delete-btn {
	position: absolute;
	background: none;
	border: none;
	color: gray;
	font-size: 18px;
	top: 2.5%;
	right: 2%;
}
.delete-btn:hover {
	color: black;
	font-weight: bold;
}

.product-info p {
	margin: 2px 0;
	text-align: left;
}

.price {
	color: #8ad8f0;
	font-size: 20px;
	font-weight: bold;
}

.brand {
	font-size: 18px;
}

.name {
	color: gray;
	font-size: 18px;
	display: -webkit-box;        
  	-webkit-line-clamp: 1;       
  	-webkit-box-orient: vertical;
  	overflow: hidden;  
}

#cart-insert {
	margin-top: 2%;
	margin-left: 2%;
	margin-right: 2%;
	display: block;
	width: calc(100% - 4%);
	padding: 13px 0;
	background-color: #eefbfb;
	color: black;
	font-size: 18px;
	font-weight: bold;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	border: 1px solid #c2e4e4;
}

#cart-insert:hover {
	background: #8ad8f0;
	color: white;
}

.soldout {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);   
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;               
}
.unavailable {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);   
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;               
}

</style>
</head>
<body>


  <!-- 전역 사이드바 (공통) : 아이콘 구조로 교체 -->
  <div th:replace="~{common/myHeader}"></div>

  <!-- 전역 사이드바 (공통) -->
  <div th:replace="~{common/mySidebar}"></div>
    <div class="all">
	<div class="wish-Top">
	<form id="wishsortform" action="wishSort" method="get">
		<select id="sort" name="wishSortType">
			<option value="newest" th:selected="${ws == 'newest'}">최신순</option>
			<option value="oldest" th:selected="${ws == 'oldest'}">담은순</option>
			<option value="review" th:selected="${ws == 'review'}">리뷰많은순</option>
		</select>
	</form>
		<button type="button" id="checkdelete">선택삭제</button>
	</div>
	
	<hr>

	<span class="quantity">상품 (<span class="total-product">[[${#lists.size(wlist)}]]</span>개)</span>
	<div th:if="${#lists.isEmpty(wlist)}" class="cart-empty">
   		<p>찜이 비어 있습니다.</p>
	</div>
	<div class="product-list">
		<div class="product-item" th:if="${!#lists.isEmpty(wlist)}" th:each="w:${wlist}">
			<input type="checkbox" class="check" th:value="${w.wishlistNo}" th:data-productno="${w.productNo}" th:disabled="${w.productStock == 0 or w.productState == 'N'}"/>
			<div class="product-image">
				<a th:href="@{/Shopping/detail(productNo=${w.productNo})}">
						<img th:each="a:${alist}" th:if="${a.positionNo==w.productNo}"
						th:src="@{/} + ${a.attmRename}"
						width="102%" height="102%" style="border-radius: 8px;" />
				</a>
						
				<div th:if="${w.productStock == 0 && w.productState =='Y'}" class="soldout">
    				품절
  				</div>
  				<div th:if="${w.productState == 'N'}" class="unavailable">
    				판매중지
  				</div>
				<button class="delete-btn" type="button" th:data-wishno="${w.wishlistNo}">X</button>
			</div>
			<div class="product-info">
				<p class="price" th:text="${#numbers.formatInteger(w.productPrice,3,'COMMA')}+'원'"></p>
				<p class="brand">[[${w.productCompany}]]</p>
				<p class="name">[[${w.productName}]]</p>
			</div>
		</div>
	</div>
	<button type="button" id="cart-insert">선택 상품 장바구니 담기</button>
</div>
</body>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
	window.onload=()=>{
		
		const items = document.querySelectorAll('.check');
		const checkdelete = document.getElementById('checkdelete');
		const deleteBtn = document.querySelectorAll('.delete-btn');
		const cartInsert=document.getElementById('cart-insert');
		const sort=document.querySelector('#sort');
		const wishsortform=document.getElementById('wishsortform');
		
		if(checkdelete != null){
			checkdelete.addEventListener('click',()=>{
				const checkedItems=[];
				
				for(let i =0; i<items.length; i++){
					if(items[i].checked){
						checkedItems.push(items[i].value);
					}
				}
				
				if(checkedItems.length === 0){
					alert('삭제할 상품을 선택하세요.');
					return;
				}
				if(confirm('선택한 상품을 삭제하시겠습니까?')){
				$.ajax({
					url:'/Shopping/wishcheckDelete',
					type:'post',
					traditional:true,
					data:{wishlistNo:checkedItems},
					success: data =>{
						if(data > 0){
							alert('선택한 상품이 삭제되었습니다.');
							location.reload();
						}else{
							alert('상품 삭제 중 오류가 발생했습니다.');
						}
					},
					error:data => console.log(data)
				});
				}
			});
			
		}	
			
		
		deleteBtn.forEach(btn=>{
			btn.addEventListener('click',()=>{
				
				const wishlistNo=btn.dataset.wishno;
				
				if(wishlistNo!=null){
					if(confirm('상품을 삭제하시겠습니까?')){
						$.ajax({
							url:'/Shopping/wishproductDelete',
							type:'post',
							data:{wishlistNo:wishlistNo},
							success: data =>{
								if(data > 0){
									alert('상품이 삭제되었습니다.');
									location.reload();
								}else{
									alert('상품 삭제 중 오류가 발생했습니다.');
								}
							},
							error:data => console.log(data)
						});
					}
	
				}
			});
		});
		
		
		cartInsert.addEventListener('click',()=>{
			const checkedItems = [...document.querySelectorAll('.check:checked')].map(el => el.value);
			
			if (checkedItems.length === 0) {
		        alert('장바구니에 담을 상품을 선택해주세요.');
		        return;
		      }
			
			$.ajax({
				url:'/Shopping/wishToCart',
				type:'post',
				traditional: true,                  
		        data: { wishlistNo: checkedItems },
				success: data =>{
					if(data==-1){
						alert("로그인을 해주세요.");
						location.href='/login';
					}else if(data > 0){
						if (confirm('선택 상품을 장바구니에 담았습니다. 장바구니로 이동하시겠습니까?')) {
							location.href='/Shopping/cart';
							}
						}else{
							alert('선택 상품을 장바구니에 담는 도중 오류가 발생하였습니다.');
						}
				},
				error:data => console.log(data)
			});
		});
		
		
		if(sort){
			sort.addEventListener('change',()=>{
				wishsortform.submit();
				
				
			});
		}
		
	}
		
</script>

</html>