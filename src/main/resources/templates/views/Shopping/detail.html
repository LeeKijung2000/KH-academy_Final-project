<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>상품 상세페이지</title>
<style>
body {
	font-family: 'Apple SD Gothic Neo', sans-serif;
	background-color: #fff;
	color: #333;
}

.product-container {
	margin-top: 60px;
}

.product-image {
	max-width: 100%;
	border-radius: 10px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.brand-name {
	color: #777;
	font-size: 14px;
}

.product-title {
	font-size: 24px;
	font-weight: bold;
}

.product-price {
	font-size: 26px;
	color: #8ad8f0;
	font-weight: bold;
	margin-bottom: 10px;
}

.delivery-info, .payment-info {
	font-size: 14px;
	color: #555;
}

.quantity-box {
	display: flex;
	align-items: center;
	gap: 10px;
}

.total-price {
	font-size: 20px;
	color: #8ad8f0;
	font-weight: bold;
	border-top: 1px solid #ccc;
	padding-top: 15px;
}

.btn-cart, .btn-buy {
	font-size: 16px;
	padding: 12px;
}

.btn-cart {
	background-color: #fff;
	border: 1.5px solid #8ad8f0;
	color: #8ad8f0;
	border-radius: 6px;
	width: 300px;

}
btn-cart:hover {
		background: #8ad8f0;
	color: white;
	border: 1.5px solid #ccc;
}

.btn-wish{
	border: 1.5px solid #ccc;
	background-color: #fff;
	padding:1.5%;
	border-radius: 6px;
	
}

.btn-buy {
	background-color: #eefbfb;
	color: black;
	border: 1.5px solid #ccc;
	border-radius: 6px;
	width: 300px;

}
.btn-buy:hover {
	background: #8ad8f0;
	color: white;
	border: 1.5px solid #ccc;
}
.btn-outline-danger{
	background-color: #fff;
	border: 2px solid #8ad8f0;
	color: #8ad8f0;
}

.thumbnail-list img {
	width: 60px;
	height: 60px;
	object-fit: cover;
	border: 1px solid #ddd;
	border-radius: 6px;
	cursor: pointer;
}

.rating {
	color: #f93;
}

.tabs-section {
	margin-top: 50px;
}

/* 기본 배경 색상 설정 */
#review {
    background-color: rgba(138, 216, 240, 0.4);
    padding: 20px;
    border-radius: 10px;
}

/* 각 리뷰 카드 스타일 */
.review-card {
    background-color: #fff;
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* 리뷰 헤더 (사용자 이름과 평점) */
.review-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.user-name {
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
    margin-right: 10px;
}

.ratingStar {
    font-size: 1.5em;
    color: #ff9800;
}

/* 리뷰 본문 스타일 */
.review-content {
    font-size: 1em;
    color: #555;
    margin-bottom: 10px;
    text-align: left;
}

/* 답변 영역 스타일 */
.response {
    background-color: #f1f1f1;
    padding: 10px;
    margin-top: 15px;
    border-radius: 5px;
}

.response-header {
    font-weight: bold;
    color: black;
    margin-bottom: 5px;
    text-align: left;
}

.response-content {
    font-size: 1em;
    color: #333;
    margin-top: 5px;
    text-align: left;
}

#QnA{
	background-color: #fff;
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.questionUser{
	text-align: left;
	font-size: 1.2em;
    font-weight: bolder;
    color: #333;
    margin-right: 10px;
}

.questionTitle{
	font-size: 1em;
    color: #555;
    margin-bottom: 10px;
    text-align: left;
}

.questionContent{
	font-size: 1em;
    color: #555;
    margin-bottom: 10px;
    text-align: left;
}

.answerArea{
	background-color: #f1f1f1;
    padding: 10px;
    margin-top: 15px;
    border-radius: 5px;
    text-align: left;
}

#downCoupon {
	cursor: pointer;
}

.soldout {
	position: absolute;
	top: 0; left: 0; right: 0; bottom: 0;
	background: rgba(0, 0, 0, 0.5);   
	color: #fff;
	font-size: 18px;
	font-weight: bold;
	display: flex;
	align-items: center;
	justify-content: center;
	border-radius: 8px;
}
.unavailable {
	position: absolute;
	top: 0; left: 0; right: 0; bottom: 0;
	background: rgba(0, 0, 0, 0.5);   
	color: #fff;
	font-size: 18px;
	font-weight: bold;
	display: flex;
	align-items: center;
	justify-content: center;
	border-radius: 8px;        
}

.item-image {
	width: 550px;
	height: 550px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 12px;
	margin-right: 10px;
	margin-bottom: 10px;
	border-radius: 6px;
	position: relative;
}

#couponSelect {
	width: 350px;
	border-radius: 6px;
	font-weight: bolder;
}

.product-specificity {
	font-weight: bolder;
	font-size: small;
}

</style>
<link rel="stylesheet" th:href="@{/css/inhoCss/reportModal.css}">
</head>
<body>

	<div th:replace="~{common/header :: header}"></div>

	<div class="container product-container">
		<input type="hidden" id="productNo" th:value="${p.productNo}"/>
		<input type="hidden" id="userNo" th:if="${session.loginUser != null}" th:value="${session.loginUser.userNo}"/>
		<div class="row">
			<!-- 좌측: 이미지 및 썸네일 -->
			<div class="col-md-6">
				<div class="item-image">
					<img th:src="@{/} + ${attm.attmRename}" class="product-image mb-3" alt="상품 이미지">
					<div th:if="${p.productStock == 0 && p.productState == 'N'}" class="soldout">일시 품절</div>
					<div th:if="${p.productState == 'N' && p.productStock != 0}" class="unavailable">판매 중지</div>
				</div>
			</div>
			<!-- 우측: 상품 정보 -->
			<div class="col-md-6">
				<p class="brand-name">[[${p.brandName}]]</p>
				<h1 class="product-title" th:if="${p.productStock != 0 && p.productState == 'Y'}">[[${p.productName}]]</h1>
				<h1 class="product-title" th:if="${p.productStock == 0 || p.productState == 'N'}" style="text-decoration: line-through;">[[${p.productName}]]</h1>
				<p class="product-price" th:text="${#numbers.formatInteger(p.productPrice, 3, 'COMMA') + '원'}"/>
				<p class="product-specificity">[[${p.ingredient}]]</p>
				<p class="product-specificity">[[${p.ecoFriendly}]]</p>
				<p class="text-danger">
					<select th:if="${cList.size() != 0}" id="couponSelect">
						<option th:each="c : ${cList}" th:value="${c.couponNo}">[[${c.couponName}]]  ([[${c.couponDiscount}]]% 할인)</option>
					</select>
				</p>
				<p th:if="${cList.size() != 0}" id="downCoupon">🎫 쿠폰 발급받기</p>
			    <button th:if="${session.loginUser != null}" class="btn flex-fill" th:onclick="openReportModal('P', '[[${p.productNo}]]')">🚨신고</button>
			    <button th:if="${session.loginUser != null}" class="btn flex-fill" id="inquiryButton">❔문의하기</button>

				<hr>

				<div class="payment-info mb-3">
					<strong>결제혜택</strong><br> CJ카드 추가 10% 할인<br> 포인트 최대 1% 적립
				</div>

				<div class="mb-3 quantity-box">
					<label>수량</label> 
					<input type="number" class="form-control w-25" th:if="${p.productStock != 0 && p.productState == 'Y'}" id="stock" value="1" min="1" th:max="${p.productStock}">
					<input type="number" class="form-control w-25" id="zeroStock" th:if="${p.productStock == 0 || p.productState == 'N'}" value="0">
				</div>

				<input type="hidden" id="productPrice" th:value="${p.productPrice}"/>
				<div class="total-price mb-3" th:data-value="${p.productPrice}" id="totalPrice" th:text="'총 상품 금액 : ' + ${#numbers.formatInteger(p.productPrice, 3, 'COMMA') + ' 원'}"></div>
				
				<!-- 서연 -->
				<div class="d-flex gap-2" th:if="${p.productStock == 0 || p.productState == 'Y'}">
				     <button class="btn-wish" th:data-wish="${wishlistNo}">
				    
				    	<svg th:if="${wishlistNo == null or wishlistNo==0}" xmlns="http://www.w3.org/2000/svg" viewBox="-41.31 -41.31 300.03 300.03" width="28" height="29" fill="black" stroke="black" stroke-width="4">
				    	<path d="M194.078,22.682c-10.747-8.193-22.606-12.348-35.248-12.348c-15.951,0-33.181,6.808-50.126,19.754C91.759,17.142,74.529,10.334,58.578,10.334c-12.642,0-24.501,4.155-35.248,12.348C7.606,34.671-0.24,49.8,0.006,67.648c0.846,61.117,100.093,133.233,104.317,136.273l4.381,3.153l4.381-3.153c4.225-3.04,103.472-75.156,104.317-136.273C217.648,49.8,209.802,34.671,194.078,22.682z
					           M153.833,149.017c-18.374,18.48-36.915,33.188-45.129,39.453
					           c-8.214-6.265-26.755-20.972-45.129-39.453c-31.479-31.661-48.274-59.873-48.57-81.585
					           c-0.178-13.013,5.521-23.749,17.421-32.822c8.073-6.156,16.872-9.277,26.152-9.277
					           c17.563,0,34.338,10.936,45.317,20.11l4.809,4.018l4.809-4.018
					           c10.979-9.174,27.754-20.11,45.317-20.11c9.28,0,18.079,3.121,26.152,9.277
					           c11.9,9.073,17.599,19.809,17.421,32.822
					           C202.107,89.145,185.311,117.356,153.833,149.017z"/>
						</svg>
				    	<svg th:if="${wishlistNo != null or wishlistNo>0}" xmlns="http://www.w3.org/2000/svg" width="27" height="29" viewBox="-132 -132 1464 1464" fill="#ef6b6b" stroke="#ef6b6b">
							  <path d="M1176.629,250.347c54.502,168.401,8.89,339.761-87.232,468.872
							           c-63.446,87.553-139.273,163.012-216.796,228.983
							           c-71.322,66.39-230.933,197.753-273.241,201.402
							           c-37.394-7.148-79.353-49.433-109.039-71.196
							           C323.503,951.599,143.93,797.388,52.878,628.779
							           c-76.34-161.871-76.48-362.086,42.333-486.189
							           C249.271,3.702,481.533,30.841,599.359,175.944
							           c31.644-41.05,70.556-73.335,116.737-96.853
							           C903.309,4.363,1098.068,80.509,1176.629,250.347z"/>
						</svg>
				    </button>
				    <button class="btn-cart">🛒 장바구니</button>
				    <button class="btn-buy" th:attr="data-product=${p.productNo},data-stock=${p.productStock}" th:if="${p.productStock != 0 && p.productState == 'Y'}">💳 바로구매</button>
				</div>
			</div>
		</div>

		<!-- 탭 -->
		<div class="tabs-section">
			<ul class="nav nav-tabs mt-5" id="productTab" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">상세정보</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab">후기 ([[${reviewCount}]])</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="QnA-tab" data-bs-toggle="tab" data-bs-target="#QnA" type="button" role="tab">상품 Q&A</button>
				</li>
			</ul>
			<div class="tab-content" id="productTabContent" style="text-align: center;">
				<div class="tab-pane fade show active p-3" id="detail" role="tabpanel" th:utext="${p.productDetail}">
				</div>
				<div class="tab-pane fade p-3" id="review" role="tabpanel">
					<div th:if="${rList.size() == 0}">
						후기가 등록되지 않았습니다.
						<br/>
						후기를 등록해주세요!
					</div>
				    <div th:if="${rList.size() != 0}" th:each="r : ${rList}">
				        <div class="review-card">
				            <!-- 리뷰 내용 -->
				            <div class="review-header">
				            	<input type="hidden" class="reviewId" th:value="${r.reviewNo}"/>
				                <span class="user-name">[[${r.userName}]]</span>
				                <div class="ratingStar" th:text="${r.reviewRate}"></div>
<!-- 				            리뷰 신고버튼 추가 -->
								<button th:if="${session.loginUser != null}" class="btn flex-fill" th:onclick="openReportModal('R', '[[${r.reviewNo}]]')">🚨신고</button>
				            </div>
				            <div class="review-content">[[${r.reviewContent}]]</div>
				            
				             <!-- 리뷰에 대한 답변 영역 -->
				            <div class="response" th:if="${r.reviewAnswerId != 0}">
				            	<input type="hidden" class="productNo" th:value="${r.productNo}"/>
							    <div class="response-header">[[${p.brandName}]]</div>
							    <div class="response-content">
									<input type="hidden" class="reviewAnswerId" th:value="${r.reviewAnswerId}"/>
							        <p class="reviewAnswerContent" th:text="${r.reviewAnswerContent}"></p>
							    </div>
							</div>
				        </div>
				    </div>
				</div>
				<div class="tab-pane fade p-3" id="QnA" role="tabpanel">
					<th:block th:each="q : ${qList}">
						<div class="questionUser">[[${q.userName}]]</div>
						<div class="questionContent">문의 내용 : [[${q.questionContent}]]</div>
						
						<th:block th:each="a : ${aList}">
							<div th:if="${q.questionNo == a.questionNo}">
								<div class="answerArea">
									<strong>[[${a.productCompany}]]</strong>
									<br/>
									<div>[[${a.answerContent}]]</div>
								</div>
							</div>
						</th:block>
						<br/><br/>
					</th:block>
				</div>
			</div>
		</div>
	</div>
	
	<div id="reportModal" style="display: none;">
	    <div class="modal-content">
	      <h3>신고하기</h3>
	      <form action="/inhoAdmin/enrollProductReport" id="reportForm" method="post">
	        <input type="hidden" name="reportType" id="reportType">
	        <input type="hidden" name="reportTargetNo" id="reportTargetNo">
	        <input type="hidden" name="productNo" th:value="${p.productNo}" />
	
	        <label for="reportTitle">신고 제목</label>
	        <input type="text" name="reportTitle" id="reportTitle">
	
	        <label for="reportContent">신고 사유</label>
	        <textarea id="reportContent" name="reportContent" required></textarea>
	
	        <button type="submit">등록</button>
	        <button type="button" onclick="closeReportModal()">취소</button>
	      </form>
	    </div>
	  </div>
	
	<div th:replace="~{common/footer :: footer}"></div>
	<script th:src="@{/js/inhoAdmin/alert.js}"></script>
	<script th:src="@{/js/inhoAdmin/reportModal.js}"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	
	<script th:inline="javascript">
		const msg = /*[[${msg}]]*/ null;
		if (msg) {
		    alert(msg);
		}
		window.onload = () => {
			const ratingStars = document.querySelectorAll('.ratingStar');
			const btnbuy=document.querySelector('.btn-buy');
			const userNo=document.getElementById('userNo');
			const productNo=document.getElementById('productNo').value;
			const btncart=document.querySelector('.btn-cart');
			const btnwish=document.querySelector('.btn-wish');

			
			//console.log(ratingStar)
			for(ratingStar of ratingStars){
				const rating = ratingStar.innerText;
				//console.log(rating)
				const filledStar = '\u2605';
				const starString = filledStar.repeat(rating);
				//console.log(starString)
				ratingStar.innerText = starString;
				
			}
			const productStock = document.querySelector('#stock');
			const productPrice = document.querySelector('#productPrice');
			const totalPrice = document.querySelector('#totalPrice');
			
			//console.log(productStock)
			//console.log(productPrice.value)
			
			if(productStock != null){
				productStock.addEventListener('change', () => {
					const productTotalPrice = (productStock.value*productPrice.value).toLocaleString();
					//console.log(productTotalPrice)
					totalPrice.innerText = '총 상품 금액 : ' + productTotalPrice + ' 원';
				})
			}
			
			<!--서연-->
			if(btnbuy != null){
				btnbuy.addEventListener('click',()=>{
					const productNo=btnbuy.dataset.product;
					const stockMax=btnbuy.dataset.stock;
					const amount=productStock.value;
					if(!userNo){
						alert("로그인 후 이용해주세요.");
						location.href="/login/login";
						return;
					}
					
					if(parseInt(amount)>parseInt(stockMax)){
						alert("재고 수량을 초과하였습니다.");
						return;
					}
					
					const totalPrice = document.getElementById("totalPrice").dataset.value;
					
					location.href="/Shopping/payMent?productNo="+productNo+"&amount="+amount +"&totalPrice="+totalPrice;
				});
				
			}
			if(btncart != null) {
				btncart.addEventListener('click',()=>{
					
					if(!userNo){
						alert("로그인 후 이용해주세요.");
						location.href="/login/login";
						return;
					}
					
					
					const amount=productStock.value;
					if(productNo){
						if(confirm('상품을 장바구니에 담으시겠습니까?')){
							$.ajax({
								url:'/Shopping/productToCart',
								type:'post',
								data:{productNo:productNo,amount:amount},
								success: data =>{
									if(data > 0){
										if (confirm('상품이 장바구니에 담겼습니다. 장바구니로 이동하시겠습니까?')){
											location.href="/Shopping/cart";
										}
										
									}else{
										alert('상품을 장바구니에 담는 도중 오류가 발생했습니다.');
									}
								},
								error:data => console.log(data)
							});
						}
		
					}
				});
				
			}			
			
			if(btnwish != null) {
				btnwish.addEventListener('click',()=>{
					if(!userNo){
						alert("로그인 후 이용해주세요.");
						location.href="/login/login";
						return;
					}
					let wishlistNo = parseInt(btnwish.dataset.wish || 0);
					
					if(wishlistNo==0){
						$.ajax({
							url:'/Shopping/addWish',
							type:'post',
							data:{productNo:productNo},
							success: data =>{
								if(data>0){
									btnwish.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="27" height="29" viewBox="-132 -132 1464 1464" fill="#ef6b6b" stroke="#ef6b6b"><path d="M1176.629,250.347c54.502,168.401,8.89,339.761-87.232,468.872 c-63.446,87.553-139.273,163.012-216.796,228.983 c-71.322,66.39-230.933,197.753-273.241,201.402 c-37.394-7.148-79.353-49.433-109.039-71.196  C323.503,951.599,143.93,797.388,52.878,628.779  c-76.34-161.871-76.48-362.086,42.333-486.189C249.271,3.702,481.533,30.841,599.359,175.944c31.644-41.05,70.556-73.335,116.737-96.853 C903.309,4.363,1098.068,80.509,1176.629,250.347z"/></svg>';
									btnwish.dataset.wish = data;
								}
							},
							error:data => console.log(data)
						});
					}else{
						$.ajax({
							url:'/Shopping/removeWish',
							type:'post',
							data:{productNo:productNo},
							success: data =>{
								if(data>0){
									btnwish.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="-41.31 -41.31 300.03 300.03" width="28" height="29" fill="black" stroke="black" stroke-width="4"><path d="M194.078,22.682c-10.747-8.193-22.606-12.348-35.248-12.348c-15.951,0-33.181,6.808-50.126,19.754C91.759,17.142,74.529,10.334,58.578,10.334c-12.642,0-24.501,4.155-35.248,12.348C7.606,34.671-0.24,49.8,0.006,67.648c0.846,61.117,100.093,133.233,104.317,136.273l4.381,3.153l4.381-3.153c4.225-3.04,103.472-75.156,104.317-136.273C217.648,49.8,209.802,34.671,194.078,22.682z M153.833,149.017c-18.374,18.48-36.915,33.188-45.129,39.453 c-8.214-6.265-26.755-20.972-45.129-39.453c-31.479-31.661-48.274-59.873-48.57-81.585 c-0.178-13.013,5.521-23.749,17.421-32.822c8.073-6.156,16.872-9.277,26.152-9.277 c17.563,0,34.338,10.936,45.317,20.11l4.809,4.018l4.809-4.018 c10.979-9.174,27.754-20.11,45.317-20.11c9.28,0,18.079,3.121,26.152,9.277 c11.9,9.073,17.599,19.809,17.421,32.822 C202.107,89.145,185.311,117.356,153.833,149.017z"/></svg>'
										btnwish.dataset.wish = 0;
								}
							},
							error:data => console.log(data)
						});
					}
					
					
				});
				
			}

			const zeroStock = document.querySelector('#zeroStock');
			if(zeroStock != null){
				zeroStock.addEventListener('change', () => {
					alert('현재 구매 불가능한 상품입니다.');
					alert('메인 화면으로 돌아갑니다.');
					location.href = '/';
				})
			}
			
			if(document.querySelector('#downCoupon') != null){
				document.querySelector('#downCoupon').addEventListener('click', () => {
					const couponNo = document.querySelector('#couponSelect').value
					const userNo = document.querySelector('#userNo').value
					const productNo = document.querySelector('#productNo').value
					const couponName = document.querySelector('#couponSelect').innerText
					//console.log(couponName)
					
					alert('쿠폰이 다운로드 되었습니다.');
					location.href = '/product/downCoupon/' + userNo + '/' + couponNo + '/' + productNo;
					
				});
			}
			
			if(document.querySelector('#inquiryButton') != null){
				document.querySelector('#inquiryButton').addEventListener('click', () => {
					const productNo = document.querySelector('#productNo').value;
					alert('상품 문의 페이지로 이동합니다.')
					location.href="/product/productInquery/" + productNo;
				});
			}
		}
		
	</script>

</body>
</html>
