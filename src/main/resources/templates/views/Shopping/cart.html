<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>장바구니</title>
<script src="https://code.jquery.com/jquery-3.7.1.js"
	integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<link rel="stylesheet" th:href="@{/css/user/userCommon.css}" />

<!-- 아이콘(CDN) -->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
	integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
body {
	background: #f7f8f9;
}

.all {
	margin-right: 5%;
	margin-left: 7%;
	margin-bottom: 3%;
	margin-top: 2%;
}

.check {
	margin-bottom: 1%;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 8px;
}

input[type="checkbox"]:indeterminate {
	transform: scale(1.5);
	margin-right: 8px;
	accent-color: lightgray;
}

#checkdelete {
	float: right;
	font-size: 16px;
	background: none;
	border: none;
	color: gray;
}

#checkdelete:hover {
	font-weight: bold;
	color: black;
}

.cart-header {
	margin-bottom: 1%;
	margin-top: 1%;
}



.delete-btn:hover {
	color: black;
	font-weight: bold;
}

.cartitem {
	border: 1px solid #ccc;
	border-radius: 6px;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
	align-items: center;
	padding: 10px 16px;
	margin-top: 15px;
	margin-bottom: 18px;
	margin-left: 1%;
	margin-right: 1%;
}

.cart-header label {
	font-weight: bold;
	font-size: 18px;
}

.cart-body {
	display: flex;
	align-items: center;
	gap: 10px;
	margin-right: 1%;
	position:relative;
	margin-left: 1%;
	margin-bottom:1%;
	margin-top:2%;
}

.delete-btn {
  position: absolute;
  top: 0;   
  right:0 ; 
  background: none;
  border: none;
  color: gray;
  font-size: 15px;
  cursor: pointer;
}

.item-image {
	width: 130px;
	height: 130px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 12px;
	margin-right: 10px;
	margin-bottom: 10px;
	border-radius: 6px;
	position: relative;
}
.soldout {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);   
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;               
}
.unavailable {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);   
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;               
}

.quantity {
	margin-top: 18px;
}

.item-name {
	font-size: 18px;
	color: gray;
}
.item-name a {
  text-decoration: none; 
  color: inherit;  
  font-size: 18px;      
}


.item-price {
	color: #8ad8f0;
	font-weight: bold;
	margin-top: 0;
	margin-bottom: 12px;
	margin-left: auto;
	font-size: 18px;
}

.payment {
	margin-left: 2%;
	margin-right: 2%;
	font-weight: bold;
}

p.predict {
	font-size: 20px;
	font-weight: bold;
	margin-top: 2%;
	margin-bottom: 0;
}

p.total-price {
	color: gray;
	font-size: 18px;
	margin-top: 2%;
}

p.coupon-notice {
	color: gray;
	font-size: 18px;
	margin: 0; /* p 태그 기본 여백 제거 */
}

select[name="coupon-option"] {
	color: rgb(0, 0, 0);
	font-size: 16px;
	text-decoration: none;
	height: 40px;
	width: 30%;
	border: 1px solid #34e5eb;
	border-radius: 6px;
	overflow:hidden;
}

.coupon {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin: 5px 0;
	font-size: 18px;
}
#sort option:disabled{
	background-color:#e0e0e0;
	color:white;
}
#sort option:not(:disabled){
	font-weight:bold;
}
.total {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin: 5px 0;
	font-size: 18px;
	line-height: 1;
}

.total-price {
	color: gray;
}

.total-product {
	color: gray;
}

.total-coupon {
	color: gray;
}

.total-discount-price {
	color: gray;
}

.point {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin: 5px 0;
	font-size: 18px;
	line-height: 1;
}

.point-exception {
	color: gray;
}

.point-amount {
	color: gray;
}
.point-note{
	font-size:13px;
	font-style:italic;
	color:#d9d9d9;
}
#product-order {
	display: block;
	width: 100%;
	padding: 13px 0;
	background-color: #eefbfb;
	color: black;
	font-size: 18px;
	font-weight: bold;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	border: 1px solid #c2e4e4;
}

#product-order:hover {
	color: white;
	background: #8ad8f0;
}

.qty-btn {
	display: inline-flex;
	justify-content: center;
	align-items: center;
	width: 30px;
	height: 30px;
	line-height: 1;
	padding: 0;
	vertical-align: middle;
}

.minus {
	background: white;
	color: black;
	border: 1px solid #ccc;
	border-radius: 50%;
	font-weight: bold;
	font-size: 18px;
}

.minus:hover {
	background: gray;
	color: white;
}

.plus {
	background: #eefbfb;
	color: gray;
	border: 1px solid #ccc;
	border-radius: 50%;
	font-weight: bold;
	font-size: 18px;
}

.plus:hover {
	background: #8ad8f0;
	color: white;
}

.qty-btn:disabled,
.qty-btn:disabled:hover {
	background-color: lightgray !important;
	color: #999 !important;
	cursor: not-allowed !important;
	opacity: 0.6 !important;
	pointer-events:none;
}

 
</style>
</head>
<body>
	<!-- 전역 헤더 (공통) -->
	<header class="site-header">It:View</header>

	<!-- 전역 사이드바 (공통) : 아이콘 구조로 교체 -->
	<nav class="sidenav" aria-label="Primary">
		<div class="sidenav-top">
			<a class="nav-item active" href="/my/myPage"><i
				class="fa-solid fa-user"></i><span>마이페이지</span></a> <a class="nav-item"
				href="/experience/experienceApplication"><i
				class="fa-solid fa-gift"></i><span>체험단 신청</span></a> <a class="nav-item"
				href="/my/myReview"><i class="fa-solid fa-star"></i><span>리뷰</span></a>
			<a class="nav-item" href="/Shopping/cart"><i
				class="fa-solid fa-cart-shopping"></i><span>장바구니</span></a> <a
				class="nav-item" href="/Shopping/WishList"><i
				class="fa-solid fa-heart"></i><span>찜</span></a> <a class="nav-item"><i
				class="fa-solid fa-right-from-bracket"></i><span>로그아웃</span></a>
		</div>
	</nav>
	<div class="all">
		<div class="check">
			<label><input type="checkbox" id="checkAll">전체선택</label>
			<button type="submit" id="checkdelete">선택삭제</button>
		</div>
		<hr>
		<div th:if="${#lists.isEmpty(clist)}" class="cart-empty">
   			<p>장바구니가 비어 있습니다.</p>
		</div>
		<div class="cartitem" th:if="${!#lists.isEmpty(clist)}"
			th:each="gc:${cartGroup}">
			
			
			
			<div class="cart-header">
				<label><input type="checkbox" class="checkcompany"
					 th:data-company="${gc.key}" >[[${gc.key}]]</label>

			</div>
			
			<div  class="cart-body" th:each="c : ${gc.value}">
				<label><input type="checkbox" class="checkItem" th:data-price="${c.productPrice}"
					th:value="${c.cartNo}" th:data-company="${gc.key}" th:disabled="${c.productStock == 0 or c.productState == 'N'}"></label>
				<div class="item-image">
					<a th:href="@{/Shopping/detail(productNo=${c.productNo})}">
						<img th:each="a:${alist}" th:if="${a.positionNo==c.productNo}"
						th:src="@{/} + ${a.attmRename}"
						width="100%" height="100%" style="border-radius: 8px;" />
					</a>
					<div th:if="${c.productStock == 0 && c.productState =='Y'}" class="soldout">
    					품절
  					</div>
  					<div th:if="${c.productState == 'N'}" class="unavailable">
    					판매중지
  					</div>
				</div>
				
				<div class="item">
					<div class="item-price" th:data-price="${c.productPrice}"
						th:text="${#numbers.formatInteger(c.productPrice * c.amount,3,'COMMA')}+'원'">가격</div>
					<div class="item-name">
						<a th:href="@{/Shopping/detail(productNo=${c.productNo})}">
							<span th:text="${c.productName}">이름</span>
						</a>
					</div>

					<div class="quantity">
						<button class="qty-btn minus" type="button">-</button>
						<span th:text="${c.amount}" class="qty"
							th:data-stock="${c.productStock}"
     						th:data-state="${c.productState}">갯수</span>
						<button class="qty-btn plus" type="button">+</button>
					</div>
				</div>
				<button type="button" class="delete-btn"
					th:data-cartno="${c.cartNo}">X</button>
			</div>
			</div>
		

	
		
		<hr>
		<div class="payment">
			<p class="predict">예상결제금액</p>

			<div class="total">
				<p class="total-price">총 상품금액</p>
				<p class="total-product" style="color: black;">0원</p>
			</div>
			<div class="coupon">
				<p class="coupon-notice">쿠폰할인</p>
				<select id="sort" name="coupon-option" th:data-usergrade="${loginUser.userGrade}">
					<option value="notice" disabled selected>쿠폰을 선택해주세요</option>
					<option value="none">선택안함</option>
					<option value="all" th:each="cp:${couponlist}" th:value="${cp.personalCouponNo}"
										th:attr="data-minprice=${cp.couponMinprice},data-start=${cp.couponStartdate},data-brand=${cp.brandName != null ? cp.brandName:''} ,
												data-end=${cp.couponEnddate},data-disc=${cp.couponDiscount},data-coupontarget=${cp.couponTarget}">[[${cp.couponName}]] (할인율:[[${cp.couponDiscount}]]%, 최소주문금액:[[${#numbers.formatInteger(cp.couponMinprice,3,'COMMA')}]]원)</option>
				</select>
			</div>
			<div class="total">
				<p class="total-coupon">총 주문금액</p>
				<p class="total-discount-price" style="color: black;">0원</p>
			</div>
			<div class="point">
				<p class="point-exception">예상 적립 포인트<br><span class="point-note">* 주문 금액의 1%가 적립됩니다.</span></p>
				<p class="point-amount" style="color: black;">0원</p>
			</div>
		</div>
		<button type="submit" id="product-order">상품 주문하기</button>
	</div>
</body>
<script>
	window.onload=()=>{
		const all = document.getElementById('checkAll');
		const items = document.querySelectorAll('.checkItem');
		const checkdelete = document.getElementById('checkdelete');
		const deleteBtn = document.querySelectorAll('.delete-btn');
		const checkCompany = document.querySelectorAll('.checkcompany');
		
		
		const minusBtn = document.querySelectorAll('.qty-btn.minus');
		const plusBtn=document.querySelectorAll('.qty-btn.plus');
		const qtySpan=document.querySelectorAll('.qty');
		
		const itemPrice=document.querySelectorAll('.item-price');
		const cartBodies = document.querySelectorAll('.cart-body');
		const cartItem=document.querySelectorAll('.cartitem');
		const totalProduct = document.querySelector('.total-product');
		const totalDiscountPrice=document.querySelector('.total-discount-price');
		
		const couponDiscount=document.getElementById('sort');
		const pointreward=document.querySelector('.point-amount');
		const productOrder=document.querySelector('.product-order');
		
		
		
		const normalizeKey=(value)=>{
			if(!value)return "";
			return value.trim().toLowerCase();
		}

		const updateTotal = () => {
	        let sum = 0;
	        items.forEach(check => {
	            if (check.checked && !check.disabled) {
	                const productBox = check.closest('.cart-body');   // 체크박스가 속한 상품
	                const productPriceBox = productBox.querySelector('.item-price');
	                const productQty = productBox.querySelector('.qty');

	                const unit = parseInt(productPriceBox.dataset.price); 
	                const qty  = parseInt(productQty.textContent);

	                sum += unit * qty;
	            }
	        });
	        totalProduct.textContent = sum.toLocaleString() + '원';
	    };
	    
	    
	    
		
		const selectCheckProduct=()=>{
			let total=0;
			let sellerMap={};
			
			items.forEach(check=>{
				if(check.checked && !check.disabled){
					const productBox = check.closest('.cart-body');   
	                const productPriceBox = productBox.querySelector('.item-price');
	                const productQty = productBox.querySelector('.qty');

	                const unit = parseInt(productPriceBox.dataset.price); 
	                const qty  = parseInt(productQty.textContent);
					const sellerKey=check.dataset.company.toLowerCase();
					
	                total += unit * qty;
	                
	                
	                if(sellerMap[sellerKey]==undefined){
	                	sellerMap[sellerKey]=0;
	                }
	                sellerMap[sellerKey]=sellerMap[sellerKey]+(unit*qty);
				}
			});
			
			return{total,sellerMap};
		};
		
		
		const couponActivation=()=>{
			
			const {total,sellerMap}=selectCheckProduct();
			const selectBox =document.getElementById("sort");
			const options=document.querySelectorAll("option");
			const userGrade=(selectBox.dataset.usergrade || "").toLowerCase();
			
			
			
			options.forEach(opt=>{
				if(opt.value!="notice" && opt.value!='none')opt.disabled=true;
				
				
			});
			
			if(total==0)return;
			
			options.forEach(opt=>{
				
				if (opt.value == "notice" || opt.value=='none') return;
				const min=parseInt(opt.dataset.minprice || 0);
				const target=(opt.dataset.coupontarget||"").toLowerCase();
				const brand=(opt.dataset.brand||"").toLowerCase();
				
				let useCoupon=false;
				
				if(!brand){
					if((target=="all" || target==userGrade) && total >= min){
						useCoupon=true;
					}
				}else{
					const brandSum=sellerMap[brand] || 0;
					if(brandSum>=min){
						useCoupon=true;
					}
				}
				
				opt.disabled =!useCoupon;
			});
		};
		
		
		const applyCoupon=()=>{
			const {total}=selectCheckProduct();
			let finalPrice=total;
			
			const selectCoupon=couponDiscount.options[couponDiscount.selectedIndex];
			
			if(total==0){
				totalProduct.textContent="0원";
				totalDiscountPrice.textContent="";
				pointreward.textContent="";
			}
			
			if(!selectCoupon || selectCoupon.value=='none'){
				totalDiscountPrice.textContent=finalPrice.toLocaleString()+'원';
				pointreward.textContent=Math.floor(finalPrice*0.01).toLocaleString()+ '원';
				
				return;
			}
			
			const discountRate=parseInt(selectCoupon.dataset.disc || 0);
			const minPrice=parseInt(selectCoupon.dataset.minprice || 0);
			
			if(total>=minPrice){
				const discount =Math.floor(total*(discountRate/100));
				finalPrice=total-discount;
			}else{
				finalPrice=total;
			}
			 totalDiscountPrice.textContent = finalPrice.toLocaleString() + '원';
		
			
			const point=Math.floor(finalPrice*0.01);
			pointreward.textContent=point.toLocaleString()+"원";
		};
		
		
	    checkCompany.forEach(chkbrd => {
	        chkbrd.addEventListener('change', () => {
	            const company = chkbrd.dataset.company;
	            items.forEach(item => {
	                if (item.dataset.company === company && !item.disabled) {
	                    item.checked = chkbrd.checked;
	                }
	            });
	            const enabledItems = [...items].filter(i => !i.disabled);
	            const total = enabledItems.length;
	            const checked = enabledItems.filter(c => c.checked).length;

	            all.checked = (checked === total);
	            all.indeterminate = (checked > 0 && checked < total);

	            updateTotal();
	            
	    		couponActivation();
	    		applyCoupon();
	        });
	    });

	    if(all != null){
	        all.addEventListener('change',()=>{
	            items.forEach(item=>{
	                if(!item.disabled){
	                    item.checked = all.checked;
	                }
	            });

	            checkCompany.forEach(chkbrd=>{
	                chkbrd.checked = all.checked;
	                chkbrd.indeterminate = false;
	            });

	            all.indeterminate = false;

	            updateTotal();
	            
	    		couponActivation();
	    		applyCoupon();
	        });

	        // 개별 체크박스 이벤트
	        items.forEach(check =>{
	            check.addEventListener('change',()=>{
	                
	            	const enabledItems = [...items].filter(i => !i.disabled);
	            	const total = enabledItems.length;
	                const checked = enabledItems.filter(c=>c.checked).length;
	                const company = check.dataset.company;
	                const companyCheckbox = [...checkCompany].find(cb => cb.dataset.company === company);
	                const companyItems = [...items].filter(i => i.dataset.company === company);
	                const checkedCount = companyItems.filter(i => i.checked).length;

	                companyCheckbox.checked = (checkedCount === companyItems.length);
	                companyCheckbox.indeterminate = (checkedCount > 0 && checkedCount < companyItems.length);

	                all.checked = (checked === total);
	                all.indeterminate = (checked > 0 && checked < total);

	                updateTotal();
	                
	        		couponActivation();
	        		applyCoupon();
	            });
	        });
	    }
		
		
		
		if(checkdelete != null){
			checkdelete.addEventListener('click',()=>{
				const checkedItems=[];
				
				for(let i =0; i<items.length; i++){
					if(items[i].checked && !items[i].disabled){
						checkedItems.push(items[i].value);
					}
				}
				
				if(checkedItems.length === 0){
					alert('삭제할 상품을 선택하세요.');
					return;
				}
			
				if(confirm('선택한 상품을 삭제하시겠습니까?')){
					$.ajax({
						url:'/Shopping/checkDelete',
						type:'post',
						traditional:true,
						data:{cartNo:checkedItems},
						success: data =>{
							if(data > 0){
								alert('선택한 상품이 삭제되었습니다.');
								location.reload();
							}else{
								alert('상품 삭제 중 오류가 발생했습니다.');
							}
						},
						error:data => console.log(data)
					});
					
				}
			});
			
		}	
			
		
		deleteBtn.forEach(btn=>{
			btn.addEventListener('click',()=>{
				
				const cartNo=btn.dataset.cartno;
				
				if(cartNo!=null){
					if(confirm('상품을 삭제하시겠습니까?')){
						$.ajax({
							url:'/Shopping/productDelete',
							type:'post',
							data:{cartNo:cartNo},
							success: data =>{
								if(data > 0){
									alert('상품이 삭제되었습니다.');
									location.reload();
								}else{
									alert('상품 삭제 중 오류가 발생했습니다.');
								}
							},
							error:data => console.log(data)
						});
					}
	
				}
			});
		})
		
		
		
		
		
		qtySpan.forEach((span,i)=>{
			const qty=parseInt(span.textContent);
			const stock=parseInt(qtySpan[i].dataset.stock);
			const state=span.dataset.state;
			
			if(stock==0 || state=='N'){
				minusBtn[i].disabled=true;
				plusBtn[i].disabled=true;
			}
			
			
			if(qty===1){
				minusBtn[i].disabled=true;
			}
			if(qty>=stock){
				plusBtn[i].disabled=true;
			}
		});
		
		 minusBtn.forEach((btn,i)=>{
		        btn.addEventListener('click',()=>{
		            const productBox = cartBodies[i];
		            const productQty = productBox.querySelector('.qty');
		            const productPriceBox = productBox.querySelector('.item-price');

		            let qty = parseInt(productQty.textContent);
		            const stock = parseInt(productQty.dataset.stock);

		            if(qty > 1){
		                qty--;
		                productQty.textContent = qty;
		            }

		            btn.disabled = (qty === 1);
		            if(qty < stock) plusBtn[i].disabled = false;

		            const unit = parseInt(productPriceBox.dataset.price); 
		            const total = unit * qty;
		            productPriceBox.textContent = total.toLocaleString()+'원';

		            updateTotal();
		            
		    		couponActivation();
		    		applyCoupon();
		        });
		    });
		
		 plusBtn.forEach((btn,i)=>{
		        btn.addEventListener('click',()=>{
		            const productBox = cartBodies[i];
		            const productQty = productBox.querySelector('.qty');
		            const productPriceBox = productBox.querySelector('.item-price');

		            let qty = parseInt(productQty.textContent);
		            const stock = parseInt(productQty.dataset.stock);

		            if(qty < stock){
		                qty++;
		                productQty.textContent = qty;

		                if(qty === 1){
		                    minusBtn[i].disabled = true;
		                } else {
		                    minusBtn[i].disabled = false;
		                }

		                const unit = parseInt(productPriceBox.dataset.price); 
		                const total = unit * qty;
		                productPriceBox.textContent = total.toLocaleString()+'원';
		            } else {
		                alert('상품이 더 이상 존재하지 않습니다. 😅');
		            }

		            if(qty === stock){
		                alert('마지막 상품입니다.');
		                btn.disabled = true;
		            }

		            updateTotal();
		            
		    		couponActivation();
		    		applyCoupon();
		        });
		    });
		 
		 couponDiscount.addEventListener('change',()=>{
			applyCoupon(); 
		 });
		
		
		couponActivation();
		 
		
		
		productOrder.addEventListener('click',()=>{
				const checkedItems=[];
				
				for(let i =0; i<items.length; i++){
					if(items[i].checked){
						checkedItems.push(items[i].value);
					}
				}
				
				if(checkedItems.length === 0){
					alert('주문할 상품을 선택하세요.');
					return;
				}
				if(confirm('선택한 상품을 주문하시겠습니까?')){
				$.ajax({
					url:'/Shopping/cartToOrder',
					type:'post',
					traditional:true,
					data:{cartNo:checkedItems},
					success: data =>{
						if(data > 0){
							location.reload();
						}else{
							alert('상품 주문 중 오류가 발생했습니다.');
						}
					},
					error:data => console.log(data)
				});
				}
			});
			
		
		
	}
	
	
	
		
	
</script>
</html>