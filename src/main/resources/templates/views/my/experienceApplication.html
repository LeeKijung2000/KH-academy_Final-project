<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EXPERIENCE_APPLICATION</title>

  <!-- 공통 레이아웃 CSS -->
  <link rel="stylesheet" th:href="@{/css/user/userCommon.css}" />

  <!-- 페이지 전용 CSS -->
  <link rel="stylesheet" th:href="@{/css/user/experienceApplication.css}" />

  <!-- 아이콘 CDN (v6) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

  <!-- ✅ 카카오(다음) 우편번호 검색 스크립트 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
  <!-- 전역 헤더 (공통) -->
  <div th:replace="~{common/myHeader}"></div>

  <!-- 전역 사이드바 (공통) -->
  <div th:replace="~{common/mySidebar}"></div>

  <div class="page">
    <!-- 상단 헤더 -->
    <header class="header">
      <button type="button" class="back-btn" aria-label="뒤로가기">←</button>
      <h1 class="title">체험단 신청하기</h1>
    </header>

    <!-- 경고 배너 -->
    <div class="alert">당첨 이후 배송지 변경은 불가합니다.</div>

    <main class="content">
      <!-- 모집글 선택 -->
      <section class="section">
        <h2 class="section-title">모집글 선택</h2>

        <div class="form-row">
          <label for="expSearch">모집글검색</label>
          <input id="expSearch" type="text" placeholder="제목/내용으로 검색" />
        </div>

        <div id="expResults" class="search-results"></div>

        <!-- 선택 결과 보관용 -->
        <input type="hidden" id="expNo" name="expNo">
        <p id="expPicked" class="helper"></p>
      </section>

      <!-- ✅ 신청 내용 (고정 높이, 인풋처럼 보이게) -->
      <section class="section">
       
        <div class="form-row">
          <label for="applyContent">신청 내용</label>
          <textarea id="applyContent" class="input-like textarea-fixed" rows="4" placeholder="신청 이유나 전달사항을 적어주세요"></textarea>
        </div>
      </section>

      <!-- 배송지 정보 -->
      <section class="section">
        <h2 class="section-title">배송지 정보</h2>

        <div class="form-row">
          <label for="receiver">받는분</label>
          <input id="receiver" type="text" placeholder="실명을 정확히 입력해주세요">
        </div>

        <div class="form-row">
          <label>휴대폰</label>
          <div class="phone-wrap">
            <input type="tel" maxlength="3" placeholder="010">
            <input type="tel" maxlength="4" placeholder="1234">
            <input type="tel" maxlength="4" placeholder="5678">
          </div>
        </div>

        <div class="form-row">
          <label for="addr1">배송지</label>
          <div class="addr-search">
            <input id="addr1" type="text" placeholder="주소를 입력해주세요">
            <!-- ✅ 버튼에 ID 부여 (우편번호 팝업 트리거) -->
            <button id="btnAddrSearch" type="button" class="btn-outline">주소검색</button>
          </div>
        </div>

        <div class="form-row no-label">
          <input id="addr2" type="text" placeholder="상세주소">
        </div>
       

        <p class="helper">* 입력된 주소는 이벤트 참여용 기본 배송지로 설정됩니다.</p>
      </section>

      <!-- 이용자 동의 -->
      <section class="section">
        <h2 class="section-title">이용자 동의</h2>
        <label class="agree">
          <input type="checkbox">
          <span>(필수) 개인정보 제3자 제공 동의</span>
        </label>
        <label class="agree">
          <input type="checkbox">
          <span>(필수) 이벤트 신청 완료 시 브랜드 즐겨찾기 추가 동의</span>
        </label>
      </section>

      <!-- 하단 버튼 -->
      <div class="submit-bar">
        <button type="button" class="btn-primary">이벤트 신청하기</button>
      </div>
    </main>
  </div>

	 <script th:inline="none">
(function () {
  const $q = document.getElementById('expSearch');
  const $list = document.getElementById('expResults');
  const $picked = document.getElementById('expPicked');
  const $expNo = document.getElementById('expNo');

  let timer = null;
  function debounce(fn, delay) {
    if (timer) clearTimeout(timer);
    timer = setTimeout(fn, delay);
  }

  async function search(keyword) {
    const url = '/my/experience/search?q=' + encodeURIComponent(keyword || '');
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('검색 실패');
    return res.json();
  }

  function statusClass(s) {
    const v = (s||'').toLowerCase();
    if (v.includes('진행') || v === 'y' || v === 'ing') return 'badge badge--ing';
    if (v.includes('종료') || v === 'd' || v === 'done') return 'badge badge--done';
    return 'badge badge--ready';
  }

  function render(items) {
    if (!Array.isArray(items) || items.length === 0) {
      $list.innerHTML = '<p class="helper">검색 결과가 없습니다.</p>';
      return;
    }
    const selected = $expNo.value; // 이미 선택된 번호
    $list.innerHTML = items.map(it => {
      const id = escapeHtml(String(it.expNo ?? ''));
      const title = escapeHtml(it.expTitle || '(제목 없음)');
      const status = escapeHtml(it.expStatus || '미정');
      const excerpt = escapeHtml((it.expContent || '').replace(/\s+/g,' ').trim()).slice(0, 120);
      const start = fmtDate(it.expStart);
      const end = fmtDate(it.expEnd);
      const isSel = selected && String(selected) === String(id);
      return `
        <div class="result-item ${isSel ? 'is-selected' : ''}" data-no="${id}">
          <div class="result-check"><i class="fa-solid fa-check"></i></div>
          <div class="result-head">
            <span class="result-id">#${id}</span>
            <span class="${statusClass(status)}">${status}</span>
          </div>
          <div class="result-title">${title}</div>
          <div class="result-meta">
            <span><i class="fa-regular fa-calendar"></i> ${start} ~ ${end}</span>
          </div>
          <div class="result-excerpt">${excerpt}</div>
        </div>
      `;
    }).join('');
  }

  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function fmtDate(d){try{ if(!d) return '-'; const x=new Date(d); if(isNaN(x)) return '-'; return x.toISOString().slice(0,10);}catch{ return '-';}}

  $q.addEventListener('input', () => {
    const kw = $q.value.trim();
    debounce(async () => {
      try {
        const data = await search(kw);
        render(data);
      } catch (e) {
        console.error(e);
        $list.innerHTML = '<p class="helper">검색 중 오류가 발생했습니다.</p>';
      }
    }, 250);
  });

  // 선택 처리
  $list.addEventListener('click', (e) => {
    const item = e.target.closest('.result-item');
    if (!item) return;
    // 선택 표시 토글(단일 선택)
    [...$list.querySelectorAll('.result-item')].forEach(el => el.classList.remove('is-selected'));
    item.classList.add('is-selected');

    const no = item.getAttribute('data-no');
    const title = item.querySelector('.result-title')?.textContent || '';
    $expNo.value = no;
    $picked.textContent = `선택된 모집글: [${no}] ${title}`;
  });

  // 초기 렌더(비우고 들어왔을 때도 예쁘게)
  render([]);
})();
</script>
	 
  

  <!-- ✅ 카카오 우편번호: 버튼 클릭 시 팝업 열기 & 주소 자동 채움 -->
  <script>
    (function () {
      const $btnSearch = document.getElementById('btnAddrSearch');
      const $addr1 = document.getElementById('addr1');
      const $addr2 = document.getElementById('addr2');

      function openPostcode() {
        if (typeof daum === 'undefined' || !daum.Postcode) {
          alert('우편번호 도구가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
          return;
        }
        new daum.Postcode({
          oncomplete: function (data) {
            // 도로명/지번 중 사용자가 선택한 주소
            var addr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;

            // 참고항목(법정동, 건물명 등) 추가
            var extra = '';
            if (data.userSelectedType === 'R') {
              if (data.bname && /[동|로|가]$/g.test(data.bname)) extra += data.bname;
              if (data.buildingName && data.apartment === 'Y') extra += (extra ? ', ' : '') + data.buildingName;
              if (extra) addr += ' (' + extra + ')';
            }

            // 기본주소 채우기
            $addr1.value = addr;

            // 상세주소 포커스
            if ($addr2) {
              $addr2.focus();
            }
          }
        }).open();
      }

      $btnSearch?.addEventListener('click', openPostcode);
    })();
  </script>

	  <script th:inline="none">
	(function () {
	  const $applyBtn = document.querySelector('.btn-primary');
	  const $expNo    = document.getElementById('expNo');
	  const $content  = document.getElementById('applyContent');
	
	  const $receiver = document.getElementById('receiver');
	  const $tels     = document.querySelectorAll('.phone-wrap input[type="tel"]');
	  const $addr1    = document.getElementById('addr1');
	  const $addr2    = document.getElementById('addr2');
	  const $addrReq  = document.getElementById('addrRequest');
	  const $agreements = document.querySelectorAll('.agree input[type="checkbox"]');
	
	  function getPhone() {
	    const parts = Array.from($tels).map(i => (i.value||'').trim());
	    return parts.join('-').replace(/-+/g,'-');
	  }
	  function isAgreed() {
	    return Array.from($agreements).slice(0,2).every(c => c.checked);
	  }
	  async function post(url, data) {
	    const res = await fetch(url, {
	      method: 'POST',
	      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
	      body: new URLSearchParams(data).toString()
	    });
	    const json = await res.json().catch(()=> ({}));
	    if (!res.ok || json.ok === false) throw new Error(json.message || '신청 처리에 실패했습니다.');
	    return json;
	  }
	
	  $applyBtn.addEventListener('click', async () => {
	    const expNo = ($expNo.value||'').trim();
	    if (!expNo) return alert('모집글을 먼저 선택해주세요.');
	    if (!isAgreed()) return alert('필수 동의 항목에 체크해주세요.');
	    if (!$receiver.value.trim()) return alert('받는분을 입력해주세요.');
	    if (!$addr1.value.trim()) return alert('주소를 입력/검색해주세요.');
	
	    const phone = getPhone();
	    const address = $addr1.value.trim() + ($addr2.value.trim() ? ' ' + $addr2.value.trim() : '');
	
	    try {
	      await post('/my/experience-apply', {
	        expNo,
	        applyContent: $content?.value || '',
	        receiver: $receiver.value.trim(),
	        phone,
	        address,
	        requestMemo: $addrReq.value.trim()
	      });
	      alert('신청이 완료되었습니다.');
	      // location.href = '/my/experienceWins';
	    } catch(e) {
	      alert(e.message);
	    }
	  });
	})();
	</script>
  
  
  
  
  
</body>
</html>
