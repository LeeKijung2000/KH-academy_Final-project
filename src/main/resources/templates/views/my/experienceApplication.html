<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EXPERIENCE_APPLICATION</title>

  <!-- 공통 레이아웃 CSS -->
  <link rel="stylesheet" th:href="@{/css/user/userCommon.css}" />

  <!-- 페이지 전용 CSS -->
  <link rel="stylesheet" th:href="@{/css/user/experienceApplication.css}" />

  <!-- 아이콘 CDN (v6) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

  <!-- ✅ 카카오(다음) 우편번호 검색 스크립트 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
  <!-- 전역 헤더 (공통) -->
  <div th:replace="~{common/myHeader}"></div>

  <!-- 전역 사이드바 (공통) -->
  <div th:replace="~{common/mySidebar}"></div>

  <div class="page">
    <!-- 상단 헤더 -->
    <header class="header">
      <button type="button" class="back-btn" aria-label="뒤로가기">←</button>
      <h1 class="title">체험단 신청하기</h1>
    </header>

    <!-- 경고 배너 -->
    <div class="alert">당첨 이후 배송지 변경은 불가합니다.</div>

    <main class="content">
      <!-- 모집글 선택 -->
      <section class="section">
        <h2 class="section-title">모집글 선택</h2>

        <div class="form-row">
          <label for="expSearch">모집글검색</label>
          <input id="expSearch" type="text" placeholder="제목/내용으로 검색" />
        </div>

        <div id="expResults" class="search-results"></div>

        <!-- 선택 결과 보관용 -->
        <input type="hidden" id="expNo" name="expNo" th:value="${expNo}" />

		<p id="expPicked" class="helper"></p>
        
      </section>

      <!-- ✅ 신청 내용 (고정 높이, 인풋처럼 보이게) -->
      <section class="section">
       
        <div class="form-row">
          <label for="applyContent">신청 내용</label>
          <textarea id="applyContent" class="input-like textarea-fixed" rows="4" placeholder="신청 이유나 전달사항을 적어주세요"></textarea>
        </div>
      </section>

      <!-- 배송지 정보 -->
      <section class="section">
        <h2 class="section-title">배송지 정보</h2>

        <div class="form-row">
          <label for="receiver">받는분</label>
          <input id="receiver" type="text" placeholder="실명을 정확히 입력해주세요">
        </div>

        <div class="form-row">
          <label>휴대폰</label>
          <div class="phone-wrap">
            <input type="tel" maxlength="3" placeholder="010">
            <input type="tel" maxlength="4" placeholder="1234">
            <input type="tel" maxlength="4" placeholder="5678">
          </div>
        </div>

        <div class="form-row">
          <label for="addr1">배송지</label>
          <div class="addr-search">
            <input id="addr1" type="text" placeholder="주소를 입력해주세요">
            <!-- ✅ 버튼에 ID 부여 (우편번호 팝업 트리거) -->
            <button id="btnAddrSearch" type="button" class="btn-outline">주소검색</button>
          </div>
        </div>

        <div class="form-row no-label">
          <input id="addr2" type="text" placeholder="상세주소">
        </div>
       

        <p class="helper">* 입력된 주소는 이벤트 참여용 기본 배송지로 설정됩니다.</p>
      </section>

      <!-- 이용자 동의 -->
      <section class="section">
        <h2 class="section-title">이용자 동의</h2>
        <label class="agree">
          <input type="checkbox">
          <span>(필수) 개인정보 제3자 제공 동의</span>
        </label>
        <label class="agree">
          <input type="checkbox">
          <span>(필수) 이벤트 신청 완료 시 브랜드 즐겨찾기 추가 동의</span>
        </label>
      </section>

      <!-- 하단 버튼 -->
      
        <div class="submit-bar">
	  <button type="button" id="btnSubmit" class="btn-primary">이벤트 신청하기</button>
	</div>

   
    </main>
  </div>

		<script th:inline="none">
	(function() {
	  const $q      = document.getElementById('expSearch');
	  const $list   = document.getElementById('expResults');
	  const $picked = document.getElementById('expPicked');
	  const $expNo  = document.getElementById('expNo');
	
	  // 필수 엘리먼트 없으면 스킵
	  if (!$q || !$list || !$picked || !$expNo) return;
	
	  let timer;
	  const debounce = (fn, d=300) => { clearTimeout(timer); timer = setTimeout(fn, d); };
	  const escapeHtml = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
	  const fmtDate = d => { try { if(!d) return '-'; const x = new Date(d); if (isNaN(x)) return '-'; return x.toISOString().slice(0,10);} catch { return '-'; } };
	
	  async function search(keyword) {
	    const res = await fetch('/my/experience/search?q=' + encodeURIComponent(keyword || ''), {
	      headers: { 'Accept': 'application/json' }
	    });
	    if (!res.ok) throw new Error('검색 실패');
	    return res.json();
	  }
	
	  async function fetchByNo(no) {
	    const res = await fetch('/my/experience/get?no=' + encodeURIComponent(no), {
	      headers: { 'Accept': 'application/json' }
	    });
	    if (!res.ok) throw new Error('조회 실패');
	    return res.json();
	  }
	
	  function render(items) {
	    if (!Array.isArray(items) || items.length === 0) {
	      $list.innerHTML = '<p class="helper">검색 결과가 없습니다.</p>';
	      return;
	    }
	    const selected = String($expNo.value || '');
	    $list.innerHTML = items.map(it => {
	      const id = escapeHtml(String(it.expNo ?? ''));
	      const title = escapeHtml(it.expTitle || '(제목 없음)');
	      const status = escapeHtml(it.expStatus || '미정');
	      const excerpt = escapeHtml((it.expContent || '').replace(/\s+/g,' ').trim()).slice(0, 120);
	      const start = fmtDate(it.expStart);
	      const end = fmtDate(it.expEnd);
	      const isSel = selected && selected === id;
	
	      return `
	        <div class="result-item ${isSel ? 'is-selected' : ''}" data-no="${id}">
	          <div class="result-head">
	            <span class="result-id">#${id}</span>
	            <span class="badge">${status}</span>
	          </div>
	          <div class="result-title">${title}</div>
	          <div class="result-meta"><i class="fa-regular fa-calendar"></i> ${start} ~ ${end}</div>
	          <div class="result-excerpt">${excerpt}</div>
	        </div>
	      `;
	    }).join('');
	  }
	
	  // 입력 검색 (디바운스)
	  $q.addEventListener('input', () => {
	    const kw = $q.value.trim();
	    debounce(async () => {
	      try { render(await search(kw)); }
	      catch (e) {
	        console.error(e);
	        $list.innerHTML = '<p class="helper">검색 중 오류가 발생했습니다.</p>';
	      }
	    });
	  });
	
	  // 선택 처리
	  $list.addEventListener('click', (e) => {
	    const item = e.target.closest('.result-item');
	    if (!item) return;
	
	    // 단일 선택 하이라이트
	    [...$list.querySelectorAll('.result-item')].forEach(el => el.classList.remove('is-selected'));
	    item.classList.add('is-selected');
	
	    const no = item.getAttribute('data-no');
	    const title = item.querySelector('.result-title')?.textContent || '';
	    $expNo.value = no;
	    $picked.textContent = `선택된 모집글: [${no}] ${title}`;
	  });
	
	  // 초기 진입: expNo가 이미 있으면(경로변수/hidden) 바로 표시 + 목록 로드
	  (async () => {
	    const initialNo = ($expNo.value || '').trim();
	    if (initialNo) {
	      try {
	        const eg = await fetchByNo(initialNo);
	        $picked.textContent = `선택된 모집글: [${eg.expNo}] ${eg.expTitle || ''}`;
	      } catch {
	        $picked.textContent = `선택된 모집글: [${initialNo}]`;
	      }
	    } else {
	      $picked.textContent = '모집글을 먼저 선택하세요.';
	    }
	
	    $list.innerHTML = '<p class="helper">검색어를 입력하면 결과가 표시됩니다.</p>';
	  })();
	})();
	</script>
	

	
	
  

  <!-- ✅ 카카오 우편번호: 버튼 클릭 시 팝업 열기 & 주소 자동 채움 -->
  <script>
    (function () {
      const $btnSearch = document.getElementById('btnAddrSearch');
      const $addr1 = document.getElementById('addr1');
      const $addr2 = document.getElementById('addr2');

      function openPostcode() {
        if (typeof daum === 'undefined' || !daum.Postcode) {
          alert('우편번호 도구가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
          return;
        }
        new daum.Postcode({
          oncomplete: function (data) {
            // 도로명/지번 중 사용자가 선택한 주소
            var addr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;

            // 참고항목(법정동, 건물명 등) 추가
            var extra = '';
            if (data.userSelectedType === 'R') {
              if (data.bname && /[동|로|가]$/g.test(data.bname)) extra += data.bname;
              if (data.buildingName && data.apartment === 'Y') extra += (extra ? ', ' : '') + data.buildingName;
              if (extra) addr += ' (' + extra + ')';
            }

            // 기본주소 채우기
            $addr1.value = addr;

            // 상세주소 포커스
            if ($addr2) {
              $addr2.focus();
            }
          }
        }).open();
      }

      $btnSearch?.addEventListener('click', openPostcode);
    })();
  </script>
  
		 <script th:inline="none">
	(function() {
	  const $q       = document.getElementById('expSearch');
	  const $list    = document.getElementById('expResults');
	  const $picked  = document.getElementById('expPicked');
	  const $expNo   = document.getElementById('expNo');
	  const $searchRow = document.querySelector('label[for="expSearch"]')?.closest('.form-row');
	
	  if (!$q || !$list || !$picked || !$expNo) return;
	
	  let timer;
	  const debounce = (fn, d=300)=>{ clearTimeout(timer); timer=setTimeout(fn,d); };
	  const esc = s=>(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
	  const fmtDate = d=>{ try{ if(!d) return '-'; const x=new Date(d); if(isNaN(x))return '-'; return x.toISOString().slice(0,10);}catch{ return '-'; }};
	
	  async function search(keyword) {
	    const res = await fetch('/my/experience/search?q=' + encodeURIComponent(keyword||''), {headers:{Accept:'application/json'}});
	    if (!res.ok) throw new Error('검색 실패');
	    return res.json();
	  }
	  async function fetchByNo(no) {
	    const res = await fetch('/my/experience/get?no=' + encodeURIComponent(no), {headers:{Accept:'application/json'}});
	    if (!res.ok) throw new Error('조회 실패');
	    return res.json();
	  }
	
	  function card(it, selected=true){
	    const id = esc(String(it.expNo ?? ''));
	    const title = esc(it.expTitle || '(제목 없음)');
	    const status = esc(it.expStatus || '미정');
	    const excerpt = esc((it.expContent||'').replace(/\s+/g,' ').trim()).slice(0,120);
	    const start = fmtDate(it.expStart);
	    const end   = fmtDate(it.expEnd);
	    return `
	      <div class="result-item ${selected?'is-selected':''}" data-no="${id}">
	        <div class="result-head"><span class="result-id">#${id}</span><span class="badge">${status}</span></div>
	        <div class="result-title">${title}</div>
	        <div class="result-meta"><i class="fa-regular fa-calendar"></i> ${start} ~ ${end}</div>
	        <div class="result-excerpt">${excerpt}</div>
	      </div>`;
	  }
	
	  function renderList(items){
	    if (!Array.isArray(items) || items.length===0) {
	      $list.innerHTML = '<p class="helper">검색 결과가 없습니다.</p>'; return;
	    }
	    const sel = String($expNo.value||'');
	    $list.innerHTML = items.map(it => card(it, sel && sel===String(it.expNo))).join('');
	  }
	
	  // 검색(최소 2자)
	  $q.addEventListener('input', ()=>{
	    const kw = $q.value.trim();
	    debounce(async ()=>{
	      if (kw.length < 2) { $list.innerHTML = '<p class="helper">검색어를 2자 이상 입력하세요.</p>'; return; }
	      try { renderList(await search(kw)); }
	      catch { $list.innerHTML = '<p class="helper">검색 중 오류가 발생했습니다.</p>'; }
	    });
	  });
	
	  // 선택 클릭
	  $list.addEventListener('click', (e)=>{
	    const item = e.target.closest('.result-item'); if(!item) return;
	    [...$list.querySelectorAll('.result-item')].forEach(el=>el.classList.remove('is-selected'));
	    item.classList.add('is-selected');
	    const no = item.getAttribute('data-no');
	    const title = item.querySelector('.result-title')?.textContent || '';
	    $expNo.value = no;
	    $picked.textContent = `선택된 모집글: [${no}] ${title}`;
	  });
	
	  // 초기 분기
	  (async ()=>{
	    const initialNo = ($expNo.value||'').trim();
	    if (initialNo) {
	      // 상세→신청 버튼 경로: 검색 UI 감추고, 단일 카드만 표시
	      if ($searchRow) $searchRow.style.display = 'none';
	      try {
	        const eg = await fetchByNo(initialNo);
	        $picked.textContent = `선택된 모집글: [${eg.expNo}] ${eg.expTitle || ''}`;
	        $list.innerHTML = card(eg, true);     // ★ 선택한 모집글만 표시
	      } catch {
	        $picked.textContent = `선택된 모집글: [${initialNo}]`;
	        $list.innerHTML = '';
	      }
	    } else {
	      // 사이드바 경로: 아무 것도 자동 표시 X
	      $picked.textContent = '모집글을 검색해 선택하세요.';
	      $list.innerHTML = '<p class="helper">검색어를 2자 이상 입력하면 결과가 표시됩니다.</p>';
	    }
	  })();
	})();
	</script>
	 
	 <script th:inline="javascript">
	  const SUBMIT_URL = /*[[@{/my/experience-apply}]]*/ '/my/experience-apply';
	 </script>
	 
	 
	<script th:inline="none">
	(function () {
	  const $btn     = document.getElementById('btnSubmit');
	  if(!$btn) return;
	
	  const $expNo   = document.getElementById('expNo');
	  const $content = document.getElementById('applyContent');
	  const $recv    = document.getElementById('receiver');
	  const [$p1,$p2,$p3] = document.querySelectorAll('.phone-wrap input');
	  const $addr1   = document.getElementById('addr1');
	  const $addr2   = document.getElementById('addr2');
	
	  async function submit() {
	    // 유효성은 생략…(있으면 그대로 사용)
	    const payload = new URLSearchParams({
	      expNo: String($expNo.value||'').trim(),
	      applyContent: ($content.value||'').trim(),
	      receiver: ($recv.value||'').trim(),
	      phone: `${$p1.value}-${$p2.value}-${$p3.value}`,
	      address: `${($addr1.value||'').trim()} ${($addr2.value||'').trim()}`
	      // requestMemo 필요하면 여기에 추가
	    });
	
	    // (선택) CSRF
	    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
	    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
	
	    try {
	      const res = await fetch(SUBMIT_URL, {
	        method: 'POST',
	        headers: {
	          'Accept': 'application/json',
	          'Content-Type': 'application/x-www-form-urlencoded',
	          ...(csrfToken && csrfHeader ? { [csrfHeader]: csrfToken } : {})
	        },
	        body: payload
	      });
	      if(!res.ok) throw new Error('전송 실패');
	      const data = await res.json();  // 컨트롤러가 Map<String,Object> 반환 → JSON
	
	      if (data.ok) {
	        alert('신청이 완료되었습니다.');
	        // 필요 시 이동
	         location.href = '/my/experienceWins';
	      } else {
	        alert(data.message || '신청 처리에 실패했습니다.');
	      }
	    } catch(e){
	      console.error(e);
	      alert('전송 중 오류가 발생했습니다.');
	    }
	  }
	
	  $btn.addEventListener('click', submit);
	})();
	</script>
	
	 

			
  
  
  
  
</body>
</html>
