<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>상품 문의</title>

  <!-- 공통 레이아웃 CSS -->
  <link rel="stylesheet" th:href="@{/css/user/userCommon.css}" />
  <!-- 페이지 전용 CSS -->
  <link rel="stylesheet" th:href="@{/css/user/myProductInquiry.css}" />
</head>
<body>

  <!-- 공통 헤더/사이드바 -->
  <div th:replace="~{common/myHeader}"></div>
  <div th:replace="~{common/mySidebar}"></div>

  <main class="page">
    <!-- 상단 타이틀바 -->
    <div class="page-topbar">
      <button class="icon-btn back" aria-label="뒤로" onclick="history.back()">←</button>
      <h1 class="page-title">상품 문의</h1>
      <span class="spacer"></span>
    </div>

    <!-- 단일 폼 -->
    <form class="form" th:action="@{/my/product-question}" method="post" autocomplete="off">
      <!-- CSRF -->
      <input type="hidden" th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <!-- 🔹 선택된 상품 번호(hidden). URL로 넘어오면 서버가 채워줌 -->
      <input type="hidden" id="productNo" name="productNo" th:value="${productNo}" />

      <!-- 상품 검색 -->
      <section class="card">
        <h2 class="sec-title" style="margin-bottom:8px">상품 검색</h2>
        <div class="search-bar">
          <input id="prodSearch" type="text" class="input" placeholder="상품명으로 검색" />
        </div>
        <!-- 현재 선택 상태 표시 -->
        <div id="prodPicked" class="picked" aria-live="polite"
             th:text="${productNo != null} ? '선택된 상품번호: ' + ${productNo} : ''"></div>
        <!-- 검색 결과 리스트 -->
        <div id="prodResults" class="results"></div>
      </section>

      <!-- 제목 -->
      <h2 class="sec-title">문의 제목</h2>
      <div class="field">
        <input type="text" class="input" name="questionTitle"
               placeholder="50자 미만으로 입력해주세요" maxlength="50" required />
      </div>

      <!-- 내용 -->
      <h2 class="sec-title">문의 내용</h2>
      <div class="field">
        <textarea class="textarea" name="questionContent" rows="6" required
                  placeholder="개인정보(이름, 연락처 등)가 포함되지 않도록 작성해주세요"></textarea>
      </div>

      <!-- 전송 -->
      <div class="submit-bar">
        <button id="submitBtn" type="submit" class="submit"
                th:disabled="${productNo == null}">
          판매자에게 전송하기
        </button>
      </div>
    </form>
  </main>

  <script th:inline="none">
  (function(){
    const $q = document.getElementById('prodSearch');
    const $list = document.getElementById('prodResults');
    const $picked = document.getElementById('prodPicked');
    const $productNo = document.getElementById('productNo');
    const $submit = document.getElementById('submitBtn');

    // URL로 productNo가 들어온 경우, 버튼 활성화
    if ($productNo && $productNo.value) {
      $submit && $submit.removeAttribute('disabled');
    }

    let timer = null;
    function debounce(fn, delay){ if (timer) clearTimeout(timer); timer = setTimeout(fn, delay); }

    async function search(keyword){
      if (!keyword) { $list.innerHTML = ''; return; }
      const res = await fetch('/my/searchProduct?keyword=' + encodeURIComponent(keyword));
      if (!res.ok) throw new Error('검색 실패');
      return res.json();
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function render(items){
      if (!Array.isArray(items) || items.length === 0){
        $list.innerHTML = '<p class="helper">검색 결과가 없습니다.</p>';
        return;
      }
      $list.innerHTML = items.map(it=>{
        const id = escapeHtml(String(it.productNo??''));
        const name = escapeHtml(it.productName||'(상품명 없음)');
        const detail = escapeHtml((it.productDetail||'').replace(/\s+/g,' ').trim());
        const thumb = escapeHtml(it.thumbUrl||'/uploadFilesFinal/default-product.png');
        return `
          <button type="button" class="result" data-no="${id}" data-name="${name}">
            <img src="${thumb}" alt="" onerror="this.onerror=null;this.src='/uploadFilesFinal/default-product.png'">
            <div class="meta">
              <div class="title">${name}</div>
              <div class="desc">${detail}</div>
            </div>
          </button>
        `;
      }).join('');
    }

    $q && $q.addEventListener('input', ()=>{
      const kw = $q.value.trim();
      debounce(async ()=>{
        try{
          const data = await search(kw);
          render(data);
        }catch(e){
          console.error(e);
          $list.innerHTML = '<p class="helper">검색 중 오류가 발생했습니다.</p>';
        }
      }, 250);
    });

    $list && $list.addEventListener('click', (e)=>{
      const item = e.target.closest('.result');
      if (!item) return;
      const no = item.getAttribute('data-no');
      const name = item.getAttribute('data-name')||'';
      $productNo.value = no;
      $picked.textContent = `선택된 상품: [${no}] ${name}`;
      $submit && $submit.removeAttribute('disabled');

      // 시각 피드백
      [...$list.querySelectorAll('.result')].forEach(el=>el.classList.remove('is-selected'));
      item.classList.add('is-selected');
    });
  })();
  </script>
</body>
</html>
