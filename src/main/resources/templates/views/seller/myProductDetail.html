<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>상품 상세페이지</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
body {
	font-family: 'Apple SD Gothic Neo', sans-serif;
	background-color: #fff;
	color: #333;
}

.product-container {
	margin-top: 60px;
}

.product-image {
	max-width: 100%;
	border-radius: 10px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.brand-name {
	color: #777;
	font-size: 14px;
}

.product-title {
	font-size: 24px;
	font-weight: bold;
}

.product-price {
	font-size: 26px;
	color: #8ad8f0;
	font-weight: bold;
	margin-bottom: 10px;
}

.delivery-info, .payment-info {
	font-size: 14px;
	color: #555;
}

.quantity-box {
	display: flex;
	align-items: center;
	gap: 10px;
}

.total-price {
	font-size: 20px;
	color: #8ad8f0;
	font-weight: bold;
	border-top: 1px solid #ccc;
	padding-top: 15px;
}

.btn-cart, .btn-buy {
	font-size: 16px;
	padding: 12px;
}

.btn-cart {
	background-color: #fff;
	border: 2px solid #8ad8f0;
	color: #8ad8f0;
}

.btn-buy {
	background-color: #eefbfb;
	color: black;
}

.thumbnail-list img {
	width: 60px;
	height: 60px;
	object-fit: cover;
	border: 1px solid #ddd;
	border-radius: 6px;
	cursor: pointer;
}

.rating {
	color: #f93;
}

.tabs-section {
	margin-top: 50px;
}

/* 기본 배경 색상 설정 */
#review {
    background-color: rgba(138, 216, 240, 0.4);
    padding: 20px;
    border-radius: 10px;
}

/* 각 리뷰 카드 스타일 */
.review-card {
    background-color: #fff;
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* 리뷰 헤더 (사용자 이름과 평점) */
.review-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.user-name {
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
    margin-right: 10px;
}

.ratingStar {
    font-size: 1.5em;
    color: #ff9800;
    width: 150px;
}

/* 리뷰 본문 스타일 */
.review-content {
    font-size: 1em;
    color: #555;
    margin-bottom: 10px;
    text-align: left;
}

/* 답변 영역 스타일 */
.response {
    background-color: #f1f1f1;
    padding: 10px;
    margin-top: 15px;
    border-radius: 5px;
}

.response-header {
    font-weight: bold;
    color: black;
    margin-bottom: 5px;
    text-align: left;
}

.response-content {
    font-size: 1em;
    color: #333;
    margin-top: 5px;
    text-align: left;
}

#QnA{
	background-color: #fff;
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.questionUser{
	text-align: left;
	font-size: 1.2em;
    font-weight: bolder;
    color: #333;
    margin-right: 10px;
}

.questionTitle{
	font-size: 1em;
    color: #555;
    margin-bottom: 10px;
    text-align: left;
}

.questionContent{
	font-size: 1em;
    color: #555;
    margin-bottom: 10px;
    text-align: left;
}

.answerArea{
	background-color: #f1f1f1;
    padding: 10px;
    margin-top: 15px;
    border-radius: 5px;
    text-align: left;
}

.buttonArea {
	margin-left: 70%;
}

.buttonArea2 {
	margin-left: 90%;
}

.reviewAnswerButton {
  background-color: #8ad8f0;
  color: white;
  border: 1px solid #c2e4e4;
  border-radius: 15px;
  padding: 10px 10px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.reviewDeleteButton {
  background-color: #8ad8f0;
  color: white;
  border: 1px solid #c2e4e4;
  border-radius: 15px;
  padding: 10px 10px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  margin-left: 10px;
}

.save-response-button {
  background-color: #8ad8f0;
  color: white;
  border: 1px solid #c2e4e4;
  border-radius: 15px;
  padding: 10px 10px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  margin-left: 37%;
}

.response-form {
	text-align: left;
}

.response-textarea {
	resize: none;
	border-radius: 10px;
}

.answerEditButton {
	background-color: #8ad8f0;
	color: white;
	border: 1px solid #c2e4e4;
	border-radius: 15px;
	padding: 10px 10px;
	cursor: pointer;
	transition: background-color 0.2s ease;
}

.answerDeleteButton {
	background-color: #8ad8f0;
	color: white;
	border: 1px solid #c2e4e4;
	border-radius: 15px;
	padding: 10px 10px;
	cursor: pointer;
	transition: background-color 0.2s ease;
	margin-left: 10px;
}

.answerEditCommitButton {
	background-color: #8ad8f0;
	color: white;
	border: 1px solid #c2e4e4;
	border-radius: 15px;
	padding: 10px 10px;
	cursor: pointer;
	transition: background-color 0.2s ease;
}

.answerEditCancelButton {
	background-color: #8ad8f0;
	color: white;
	border: 1px solid #c2e4e4;
	border-radius: 15px;
	padding: 10px 10px;
	cursor: pointer;
	transition: background-color 0.2s ease;
}

</style>
</head>
<body>

	<div class="container product-container">
		<input type="hidden" id="productNo" th:value="${p.productNo}"/>
		<div class="row">
			<!-- 좌측: 이미지 및 썸네일 -->
			<div class="col-md-6">
				<img th:src="@{/} + ${attm.attmRename}" class="product-image mb-3" alt="상품 이미지">
			</div>
			<!-- 우측: 상품 정보 -->
			<div class="col-md-6">
				<p class="brand-name">[[${p.brandName}]]</p>
				<h1 class="product-title">[[${p.productName}]]</h1>
				<p class="product-price" th:text="${#numbers.formatInteger(p.productPrice, 3, 'COMMA') + '원'}"/>
				<p>[[${p.ingredient}]]</p>
				<p>[[${p.ecoFriendly}]]</p>
				<p class="text-danger">
					<select>
						<option th:each="c : ${cList}">[[${c.couponName}]]</option>
					</select>
				</p>

				<hr>

				<div class="payment-info mb-3">
					<strong>결제혜택</strong><br> CJ카드 추가 10% 할인<br> 포인트 최대 1% 적립
				</div>

				<div class="mb-3 quantity-box">
					<label>수량</label> 
					<input type="number" class="form-control w-25" id="stock" value="1" min="1" th:max="${p.productStock}"/>
				</div>
				<input type="hidden" id="productPrice" th:value="${p.productPrice}"/>
				<div class="total-price mb-3" id="totalPrice" th:text="'총 상품 금액 : ' + ${#numbers.formatInteger(p.productPrice, 3, 'COMMA') + ' 원'}"></div>

			</div>
		</div>

		<!-- 탭 -->
		<div class="tabs-section">
			<ul class="nav nav-tabs mt-5" id="productTab" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab">상세정보</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab">후기 ([[${reviewCount}]])</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="QnA-tab" data-bs-toggle="tab" data-bs-target="#QnA" type="button" role="tab">상품 Q&A</button>
				</li>
			</ul>
			<div class="tab-content" id="productTabContent" style="text-align: center;">
				<div class="tab-pane fade show active p-3" id="detail" role="tabpanel" th:utext="${p.productDetail}">
				</div>
				<div class="tab-pane fade p-3" id="review" role="tabpanel">
				    <div th:each="r : ${rList}">
				        <div class="review-card">
				            <!-- 리뷰 내용 -->
				            <div class="review-header">
				            	<input type="hidden" class="reviewId" th:value="${r.reviewNo}"/>
				                <span class="user-name">[[${r.userName}]]</span>
				                <div class="ratingStar" th:text="${r.reviewRate}"></div>
				                <div class="buttonArea">
					                <button class="reviewAnswerButton" onclick="toggleAnswerForm(this)" th:if="${r.reviewAnswerContent == null}">답변</button>
					                <button class="reviewDeleteButton">삭제</button>
				                </div>
				            </div>
				            <div class="review-content">[[${r.reviewContent}]]</div>
				            
				            <!-- 리뷰에 대한 답변 영역 -->
				            <div class="response">
				            	<input type="hidden" class="productNo" th:value="${r.productNo}"/>
							    <div class="response-header">[[${p.brandName}]]</div>
							    <div class="response-form" style="display: none;">
								    <textarea class="response-textarea" rows="4" cols="60" placeholder="답변을 입력하세요..."></textarea>
								    <br/>
								    <button class="save-response-button">저장</button>
								</div>
							    <div class="response-content">
									<input type="hidden" class="reviewAnswerId" th:value="${r.reviewAnswerId}"/>
							        <p class="reviewAnswerContent" th:text="${r.reviewAnswerContent}"></p>
							    </div>
							</div>
							<div class="buttonArea2" th:if="${r.reviewAnswerContent != null}">
							    <button class="answerEditButton">수정</button>
							    <button class="answerDeleteButton">삭제</button>
							</div>
				        </div>
				    </div>
				</div>
				<div class="tab-pane fade p-3" id="QnA" role="tabpanel">
					<th:block th:each="q : ${qList}">
						<div class="questionUser">[[${q.userName}]]</div>
						<div class="questionContent">문의 내용 : [[${q.questionContent}]]</div>
						
						<th:block th:each="a : ${aList}">
							<div th:if="${q.questionNo == a.questionNo}">
								<div class="answerArea">
									<strong>[[${a.productCompany}]]</strong>
									<br/>
									<div>[[${a.answerContent}]]</div>
								</div>
							</div>
						</th:block>
						<br/><br/>
					</th:block>
				</div>
			</div>
		</div>
	</div>

	
	<script>
		function toggleAnswerForm(button){
			const reviewCard = button.closest('.review-card');
			const form = reviewCard.querySelector('.response-form');
			form.style.display = form.style.display === 'none' ? 'block' : 'none';
		}
		
		window.onload = () => {
			const productStock = document.querySelector('#stock');
			const productPrice = document.querySelector('#productPrice');
			const totalPrice = document.querySelector('#totalPrice');
			
			//console.log(productStock)
			//console.log(productPrice.value)
			
			productStock.addEventListener('change', () => {
				const productTotalPrice = (productStock.value*productPrice.value).toLocaleString();
				//console.log(productTotalPrice)
				totalPrice.innerText = '총 상품 금액 : ' + productTotalPrice + ' 원';
			})

			const ratingStars = document.querySelectorAll('.ratingStar');
			//console.log(ratingStar)
			for(ratingStar of ratingStars){
				const rating = ratingStar.innerText;
				//console.log(rating)
				const filledStar = '\u2605';
				const starString = filledStar.repeat(rating);
				//console.log(starString)
				ratingStar.innerText = starString;
				
			}
			
			// 리뷰 답변 등록
			const saveButtons = document.querySelectorAll('.save-response-button');
			for(saveButton of saveButtons){
				saveButton.addEventListener('click', e => {
					const reviewAnswerContent = e.target.previousElementSibling.previousElementSibling.value;
					const reviewNo = e.target.parentElement.parentElement.parentElement.children[0].children[0].value;
					const responseDiv = e.target.parentElement.parentElement;
					const responseForm = e.target.parentElement;
					const editBottns = e.target.parentElement.parentElement
					console.log(e.target.parentElement.parentElement)
					
					fetch('/seller/reviewAnswer', {
						method: 'post',
						headers: {'content-type':'application/json; charset=UTF-8'},
						body : JSON.stringify({
							reviewAnswerContent : reviewAnswerContent,
							reviewNo : reviewNo
						})
					})
					.then(res => res.json())
					.then(data => {
						//console.log(data)
						const answerContent = document.createElement('div');
						responseForm.innerHTML = '';
						answerContent.innerHTML = '<div class="response-content"><p>' + reviewAnswerContent + '</p></div>'
						responseDiv.append(answerContent);
					})
					.catch(err => console.log(err))
				});
			}
			
			// 리뷰 답변 수정
			const answerEditButtons = document.querySelectorAll('.answerEditButton');
			for(answerEditButton of answerEditButtons){
				answerEditButton.addEventListener('click', e => {
					const responseDiv = e.target.parentElement.previousElementSibling;
					const reviewAnswerId = responseDiv.children[3].children[0].value;
					const responseContentDiv = responseDiv.querySelector('p');
					const responseContent = responseContentDiv.innerText;
					const editButtonArea = responseDiv.nextElementSibling;
					console.log(editButtonArea)
					responseContentDiv.innerHTML = '<textarea class="response-textarea" row="4" cols="60">' + responseContent + '</textarea>'
					editButtonArea.innerHTML = '<button class="answerEditCommitButton">완료</button><button class="answerEditCancelButton">취소</button>'
					const commitButtons = document.querySelectorAll('.answerEditCommitButton');
					for(commitButton of commitButtons){
						commitButton.addEventListener('click', e => {
							console.log(e.target.parentElement.previousElementSibling.querySelector('p>textarea'));
						})
					}
				});
			}
			
			// 리뷰 답변 삭제
			const answerDeleteButtons = document.querySelectorAll('.answerDeleteButton');
			for(answerDeleteButton of answerDeleteButtons){
				answerDeleteButton.addEventListener('click', e => {
					const responseDiv = e.target.parentElement.previousElementSibling;
 					const reviewAnswerId = responseDiv.children[3].children[0].value;
					const productNo = responseDiv.children[0].value;
					console.log(productNo)
					if(confirm("리뷰 답변을 삭제 하시겠습니까?")){
						alert("답변이 삭제됩니다.");
						location.href = '/seller/deleteReviewAnswer/' + reviewAnswerId + '/' + productNo;
					} else {
						alert("페이지가 새로고침 됩니다.");
						location.reload();
					}
				});
			}
 		}
	</script>
</body>
</html>
