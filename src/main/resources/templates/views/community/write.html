<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>공지사항 작성</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
</head>
<body>

<div th:replace="~{common/header :: header}"></div>

<h2>공지사항 작성</h2>

<form th:action="@{/community/insert}" method="post" id="communityForm">
    <div>
        <label>제목</label>
        <input type="text" name="boardTitle" required style="width: 80%;">
    </div>

    <br>

    <div>
        <label>내용</label>
        <div id="editor"></div>
        <textarea id="boardContent" name="boardContent" style="display:none;"></textarea>
    </div>

    <!-- 업로드된 이미지 파일명 저장용 -->
    <input type="hidden" name="uploadedFiles" id="uploadedFiles">

    <button type="submit">등록</button>
</form>

<div th:replace="~{common/footer :: footer}"></div>

<script>
    const uploadedFilesArr = [];

    // Toast UI Editor 초기화
    const editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        height: '500px',
        width: '90%',
        initialEditType: 'wysiwyg',
        hideModeSwitch: true,
        toolbarItems: [
            ['heading', 'bold', 'italic', 'strike'],
            ['hr', 'quote'],
            ['ul', 'ol'],
            ['table', 'link'],
            ['image']
        ],
        hooks: {
            addImageBlobHook: async (blob, callback) => {
                const formData = new FormData();
                formData.append('image', blob);

                const response = await fetch('/community/uploadImage', {
                    method: 'POST',
                    body: formData
                });
                const tempUrl = await response.text(); // temp URL 반환
                callback(tempUrl, 'image');

                uploadedFilesArr.push(tempUrl.split('/').pop());
                document.getElementById('uploadedFiles').value = uploadedFilesArr.join(',');
            }
        }
    });

    const form = document.getElementById("communityForm");
    form.addEventListener("submit", function(e) {
        let html = editor.getHTML();
        document.getElementById("boardContent").value = html;
    });
</script>

</body>
</html>